<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>明日方舟:终末地基质筛选工具</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { max-width: 1000px; margin: 20px auto; font-family: "Microsoft Yahei", sans-serif; }
        .container { padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        .form-group { margin: 15px 0; }
        label { display: inline-block; width: 120px; font-weight: bold; }
        select { width: 300px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #0078d7; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a9e; }
        .result-area { margin-top: 30px; padding: 20px; border-top: 1px dashed #ccc; }
        .weapon-item { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .error { color: red; margin-top: 10px; }
        .success { color: green; margin-top: 10px; }
        .loading { color: #666; margin-top: 10px; }
        /* 新增：武器卡片布局（Flex排版，图片+信息） */
        .weapon-item {
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        /* 新增：武器图片样式 */
        .weapon-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            background: #ddd;
        }
        /* 新增：武器信息区域占满剩余宽度 */
        .weapon-info { flex: 1; }
    </style>
    <!-- 引入SheetJS库，解析Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
    <h1>明日方舟:终末地基质筛选工具</h1>
    <h2>武器目前仅收录六星武器和五行武器</h2>
    <h2>基质目前仅收录五星基质</h2>
    <!-- 移除文件上传框，改为自动加载GitHub里的Excel -->
    <div class="form-group">
        <div id="loadStatus" class="loading">正在加载武器数据...</div>
    </div>
    <div class="form-group">
        <label>基质基础属性：</label>
        <select id="baseAttrSelect"></select>
    </div>
    <div class="form-group">
        <label>基质附加属性：</label>
        <select id="extraAttrSelect"></select>
    </div>
    <div class="form-group">
        <label>基质技能属性：</label>
        <select id="skillAttrSelect"></select>
    </div>
    <div class="form-group">
        <label>匹配模式：</label>
        <select id="matchMode">
            <option value="false">模糊匹配（包含词条）</option>
            <option value="true">精准匹配（完全一致）</option>
        </select>
    </div>
    <div class="form-group">
        <button onclick="filterWeapons()" disabled id="filterBtn">开始筛选</button>
        <div id="msg" class=""></div>
    </div>

    <!-- 筛选结果展示 -->
    <div class="result-area">
        <h3>筛选结果：</h3>
        <div id="resultList"></div>
    </div>
</div>

<script>
    // 全局存储解析后的武器数据
    let allWeapons = [];
    // Excel文件路径（GitHub仓库内的相对路径，和index.html同目录）
    const EXCEL_FILE_PATH = "weapon_data.xlsx";
    // 新增：图片文件夹路径（GitHub仓库内的相对路径）
    const IMAGE_FOLDER_PATH = "images/";
    // 前端静态词条数据：按需维护
    const STATIC_OPTIONS = {
        base: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
        extra: ["攻击提升", "生命提升", "物理伤害提升", "灼热伤害提升", "电磁伤害提升", "寒冷伤害提升", "自然伤害提升", "暴击率提升", "源石技艺提升", "终结技效率提升", "法术伤害提升", "治疗效率提升"],
        skill: ["效益", "流转", "夜幕", "迸发", "切骨", "医疗", "附术", "残暴", "巧技", "昂扬", "粉碎", "追袭", "压制", "强攻"]
    };

    // 页面加载完成后，自动读取GitHub里的Excel
    window.onload = function() {
        fillSelectOptionsFromStatic();
        loadExcelFromGitHub();
    };

    // 从GitHub仓库读取Excel文件（通过相对路径）
    function loadExcelFromGitHub() {
        const loadStatus = document.getElementById("loadStatus");
        const filterBtn = document.getElementById("filterBtn");

        // 发送请求读取Excel文件
        fetch(EXCEL_FILE_PATH)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`加载失败：${response.status}`);
                }
                return response.arrayBuffer();
            })
            .then(data => {
                // 解析Excel
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                allWeapons = XLSX.utils.sheet_to_json(firstSheet);

                // 更新状态，启用筛选按钮
                loadStatus.className = "success";
                loadStatus.innerText = `✅ 成功加载 ${allWeapons.length} 条武器数据`;
                filterBtn.disabled = false;
            })
            .catch(err => {
                loadStatus.className = "error";
                loadStatus.innerText = `❌ 武器数据加载失败：${err.message}，请检查Excel文件路径`;
                filterBtn.disabled = true;
            });
    }

    function fillSelectOptionsFromStatic() {
        setOptions(document.getElementById("baseAttrSelect"), new Set(STATIC_OPTIONS.base));
        setOptions(document.getElementById("extraAttrSelect"), new Set(STATIC_OPTIONS.extra));
        setOptions(document.getElementById("skillAttrSelect"), new Set(STATIC_OPTIONS.skill));
    }

    function setOptions(selectEl, setData) {
        selectEl.innerHTML = "";
        const empty = document.createElement("option");
        empty.value = "";
        empty.text = "请选择词条";
        selectEl.appendChild(empty);

        Array.from(setData).sort().forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.text = val;
            selectEl.appendChild(opt);
        });
    }

    // 词条匹配逻辑
    function matchAttr(weaponAttr, matrixAttr, isExactMatch) {
        if (!matrixAttr || matrixAttr.trim() === "") return true;
        if (!weaponAttr || weaponAttr.trim() === "") return false;
        weaponAttr = weaponAttr.toString().trim();
        matrixAttr = matrixAttr.toString().trim();
        return isExactMatch ? weaponAttr === matrixAttr : weaponAttr.includes(matrixAttr);
    }

    // 筛选武器核心方法
    function filterWeapons() {
        const baseAttr = document.getElementById("baseAttrSelect").value.trim();
        const extraAttr = document.getElementById("extraAttrSelect").value.trim();
        const skillAttr = document.getElementById("skillAttrSelect").value.trim();
        const isExactMatch = document.getElementById("matchMode").value === "true";
        const msgDom = document.getElementById("msg");
        const resultList = document.getElementById("resultList");

        // 执行筛选
        const matchedWeapons = allWeapons.filter(weapon => {
            const baseMatch = matchAttr(weapon['基础属性'], baseAttr, isExactMatch);
            const extraMatch = matchAttr(weapon['附加属性'], extraAttr, isExactMatch);
            const skillMatch = matchAttr(weapon['技能属性'], skillAttr, isExactMatch);
            return baseMatch || extraMatch || skillMatch;
        });

        // 提示结果数量
        msgDom.className = "success";
        msgDom.innerText = `共找到 ${matchedWeapons.length} 个匹配的武器`;
        // 渲染结果
        renderResult(matchedWeapons);
    }

    // 渲染筛选结果（包含图片，替换原有renderResult函数）
    function renderResult(weapons) {
        const resultList = document.getElementById("resultList");
        if (!weapons || weapons.length === 0) {
            resultList.innerHTML = "<p>未找到匹配的武器！</p>";
            return;
        }

        let html = "";
        weapons.forEach(weapon => {
            // 新增：构建图片URL（读取Excel中的“图片文件名”列）
            const imageFileName = weapon['图片文件名'] || "default.png";
            const imageUrl = IMAGE_FOLDER_PATH + imageFileName;

            // 新增：图片标签 + 容错处理（onerror）
            html += `
        <div class="weapon-item">
            <img src="${imageUrl}" alt="${weapon['武器名称']}" class="weapon-img" onerror="this.src='${IMAGE_FOLDER_PATH}default.png'">
            <div class="weapon-info">
                <h3>${weapon['武器名称'] || "无"}</h3>
                <p><strong>基础属性：</strong>${weapon['基础属性'] || "无"}</p>
                <p><strong>附加属性：</strong>${weapon['附加属性'] || "无"}</p>
                <p><strong>技能属性：</strong>${weapon['技能属性'] || "无"}</p>
            </div>
        </div>
        `;
        });
        resultList.innerHTML = html;
    }
</script>
</body>
</html>